<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="booking.css">
    <title>Roomix - система бронирования аудиторий</title>
</head>
<body>
    <header>
        <h1>
            <span>R</span><span>O</span><span>O</span><span>M</span><span>I</span><span>X</span>
        </h1>
        <p class="subtitle">Бронирование аудитории</p>
    </header>

    <main>
        <form class="booking-form" id="booking-form">
            <div class="form-group">
                <label for="vuz">Выберите учебное заведение:</label>
                <select id="vuz" name="vuz" required>
                    <option value="">-- Выберите учебное заведение --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="room">Выберите аудиторию:</label>
                <select id="room" name="room" required>
                    <option value="">-- Выберите аудиторию --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="object">Дисциплина:</label>
                <select id="object" name="object" required>
                    <option value="">-- Выберите дисциплину --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="date">Дата:</label>
                <input type="date" id="date" name="date" required>
            </div>
            <div class="form-group">
                <label for="time-start">Время начала:</label>
                <input type="time" id="time-start" name="time-start" required>
            </div>
            <div class="form-group">
                <label for="time-end">Время окончания:</label>
                <input type="time" id="time-end" name="time-end" required>
            </div>
            <button type="submit" class="submit-button">Забронировать</button>
        </form>
    </main>

    <script>
        async function loadInstitutions() {
            try {
                const response = await fetch('http://localhost:8000/institutions');
                if (!response.ok) throw new Error('Ошибка загрузки ВУЗов');
                const institutions = await response.json();
                const vuzSelect = document.getElementById('vuz');
                vuzSelect.innerHTML = '<option value="">-- Выберите учебное заведение --</option>';
                institutions.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.code;
                    option.textContent = inst.name;
                    vuzSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить ВУЗы.');
            }
        }

        async function loadRooms() {
            try {
                const response = await fetch('http://localhost:8000/rooms');
                if (!response.ok) throw new Error('Ошибка загрузки аудиторий');
                const rooms = await response.json();
                const roomSelect = document.getElementById('room');
                roomSelect.innerHTML = '<option value="">-- Выберите аудиторию --</option>';
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить аудитории.');
            }
        }

        async function loadSubjects() {
            try {
                const response = await fetch('http://localhost:8000/subjects');
                if (!response.ok) throw new Error('Ошибка загрузки дисциплин');
                const subjects = await response.json();
                const subjectSelect = document.getElementById('object');
                subjectSelect.innerHTML = '<option value="">-- Выберите дисциплину --</option>';
                subjects.forEach(subj => {
                    const option = document.createElement('option');
                    option.value = subj.code;
                    option.textContent = subj.name;
                    subjectSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось загрузить дисциплины.');
            }
        }

        async function submitBooking(event) {
            event.preventDefault();
            const form = document.getElementById('booking-form');
            const formData = new FormData(form);
            const bookingData = {
                institution_code: formData.get('vuz'),
                room_id: parseInt(formData.get('room')),
                subject_code: formData.get('object'),
                date: formData.get('date'),
                time_start: formData.get('time-start'),
                time_end: formData.get('time-end')
            };

            try {
                const response = await fetch('http://localhost:8000/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                if (!response.ok) throw new Error('Ошибка создания бронирования');
                const result = await response.json();
                alert(`Бронирование создано! ID: ${result.booking_id}`);
                form.reset();
                loadInstitutions();
                loadRooms();
                loadSubjects();
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось создать бронирование.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInstitutions();
            loadRooms();
            loadSubjects();
            document.getElementById('booking-form').addEventListener('submit', submitBooking);
        });
    </script>
</body>
</html>
